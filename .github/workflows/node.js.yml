name: Microservices CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]  # Update to Node.js 16

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      # User Service
      - name: User Service - Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      # Install User Service Dependencies
      - name: User Service - Install Dependencies
        run: npm install
        working-directory: ./user-service

      # Product Service
      - name: Product Service - Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      # Install Product Service Dependencies
      - name: Product Service - Install Dependencies
        run: npm install
        working-directory: ./product-service

      # Order Service
      - name: Order Service - Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      # Install Order Service Dependencies
      - name: Order Service - Install Dependencies
        run: npm install
        working-directory: ./order-service

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: SSH deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # First, stop the currently running application (assuming it's already running)
            pm2 stop all

            # Then, update the codebase from the repository
            cd ~/CleanArchitecture-Microservice-Rabbitmq-CICD-Pipeline
            git pull origin main
            npm install

            # Finally, start the application using pm2
            pm2 start npm --name "microservices-app" -- start

